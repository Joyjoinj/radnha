<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านราดหน้ามหาชน - ระบบคำนวณรายรับรายจ่าย</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .welcome-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .restaurant-icon {
            font-size: 4rem;
            color: #ff6b6b;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }
        .navbar-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card-custom:hover {
            transform: translateY(-5px);
        }
        .menu-item {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .menu-item:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .menu-item.selected {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .order-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .btn-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .qr-section {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-top: 20px;
        }
        .expense-item {
            border-left: 4px solid #dc3545;
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
        }
        .hidden {
            display: none !important;
        }
        .tab-content {
            margin-top: 20px;
        }
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
            font-weight: 500;
        }
        .nav-pills .nav-link.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.show {
            display: block;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #28a745;
            animation: pulse-green 2s infinite;
        }
        .status-offline {
            background-color: #dc3545;
        }
        @keyframes pulse-green {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .api-setup-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-card">
            <div class="restaurant-icon">
                <i class="fas fa-utensils"></i>
            </div>
            <h2 class="mb-3" style="color: #333; font-weight: 600;">ร้านราดหน้ามหาชน</h2>
            <p class="text-muted mb-4">ระบบคำนวณรายรับรายจ่าย</p>
            <button class="btn btn-gradient btn-lg px-4 py-3" onclick="startApp()">
                <i class="fas fa-play me-2"></i>เริ่มใช้งาน
            </button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-container hidden">
        <!-- API Setup Alert -->
        <div id="apiSetupAlert" class="api-setup-alert">
            <div class="container">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>ตั้งค่า API</h6>
                <p class="mb-2">กรุณาใส่ URL ของ Google Apps Script Web App ที่ Deploy แล้วในไฟล์ HTML บรรทัดที่ระบุ</p>
                <small>สถานะ API: <span id="apiStatus" class="fw-bold text-danger">ยังไม่ได้ตั้งค่า</span></small>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-utensils text-danger me-2"></i>
                    <span style="font-weight: 600;">ร้านราดหน้ามหาชน</span>
                </a>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="status-indicator" id="connectionStatus"></span>
                        <small id="connectionText">กำลังเชื่อมต่อ...</small>
                    </div>
                    <span class="badge bg-success me-3">
                        <i class="fas fa-calendar me-1"></i>
                        <span id="currentDate"></span>
                    </span>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">กำลังโหลดข้อมูล...</p>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-pills justify-content-center mb-4" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="pill" href="#salesTab">
                        <i class="fas fa-cash-register me-2"></i>ระบบขาย
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#expenseTab">
                        <i class="fas fa-shopping-cart me-2"></i>บันทึกรายจ่าย
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#summaryTab">
                        <i class="fas fa-chart-line me-2"></i>สรุปรายงาน
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="pill" href="#menuTab">
                        <i class="fas fa-edit me-2"></i>จัดการเมนู
                    </a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Sales Tab -->
                <div class="tab-pane fade show active" id="salesTab">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card card-custom">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-list-ul me-2"></i>เมนูอาหาร</h5>
                                </div>
                                <div class="card-body">
                                    <div id="menuList" class="row">
                                        <!-- Menu items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card card-custom">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>รายการสั่งซื้อ</h5>
                                </div>
                                <div class="card-body">
                                    <div id="orderList"></div>
                                    <div class="order-summary">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>รวมทั้งหมด:</span>
                                            <span class="fw-bold" id="totalAmount">0 บาท</span>
                                        </div>
                                        <button class="btn btn-gradient w-100 mb-2" onclick="processOrder()">
                                            <i class="fas fa-check me-2"></i>ชำระเงิน
                                        </button>
                                        <button class="btn btn-outline-danger w-100" onclick="clearOrder()">
                                            <i class="fas fa-trash me-2"></i>ล้างรายการ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QR Code Section -->
                            <div class="qr-section mt-3">
                                <h6><i class="fas fa-qrcode me-2"></i>QR Code สำหรับชำระเงิน</h6>
                                <div id="qrCode" class="my-3">
                                    <div style="width: 150px; height: 150px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                        <i class="fas fa-qrcode fa-3x text-muted"></i>
                                    </div>
                                </div>
                                <small class="text-muted">สแกนเพื่อจ่ายเงิน</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expense Tab -->
                <div class="tab-pane fade" id="expenseTab">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card card-custom">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>เพิ่มรายจ่าย</h5>
                                </div>
                                <div class="card-body">
                                    <form id="expenseForm">
                                        <div class="mb-3">
                                            <label class="form-label">รายการ</label>
                                            <input type="text" class="form-control" id="expenseItem" placeholder="เช่น หมูสด, ก๋วยเตี๋ยว, น้ำมันพืช" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">จำนวนเงิน (บาท)</label>
                                            <input type="number" class="form-control" id="expenseAmount" placeholder="0" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">หมวดหมู่</label>
                                            <select class="form-select" id="expenseCategory">
                                                <option value="วัตถุดิบ">วัตถุดิบ</option>
                                                <option value="เครื่องปรุง">เครื่องปรุง</option>
                                                <option value="อุปกรณ์">อุปกรณ์</option>
                                                <option value="อื่นๆ">อื่นๆ</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">หมายเหตุ</label>
                                            <textarea class="form-control" id="expenseNote" rows="2" placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-gradient w-100">
                                            <i class="fas fa-save me-2"></i>บันทึกรายจ่าย
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card card-custom">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>รายจ่ายวันนี้</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="todayExpenses"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Tab -->
                <div class="tab-pane fade" id="summaryTab">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="summary-card">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-chart-line fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">รายรับวันนี้</h6>
                                        <h4 class="mb-0" id="todayIncome">0 บาท</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-chart-line fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">รายจ่ายวันนี้</h6>
                                        <h4 class="mb-0" id="todayExpense">0 บาท</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="summary-card" style="background: linear-gradient(135deg, #2ed573 0%, #7bed9f 100%);">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-coins fa-2x"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">กำไรวันนี้</h6>
                                        <h4 class="mb-0" id="todayProfit">0 บาท</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card card-custom">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>สรุปรายเดือน</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">เลือกเดือน/ปี</label>
                                        <input type="month" class="form-control" id="monthSelector" onchange="updateMonthlySummary()">
                                    </div>
                                    <div id="monthlySummary">
                                        <div class="text-center text-muted">เลือกเดือนเพื่อดูสรุป</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card card-custom">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>ส่งออกข้อมูล</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">ส่งออกข้อมูลเป็นไฟล์ Excel สำหรับการวิเคราะห์เพิ่มเติม</p>
                                    <button class="btn btn-gradient mb-2 w-100" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel me-2"></i>ส่งออกข้อมูลรายเดือน
                                    </button>
                                    <button class="btn btn-outline-primary w-100" onclick="exportDailyReport()">
                                        <i class="fas fa-file-alt me-2"></i>ส่งออกรายงานวันนี้
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Management Tab -->
                <div class="tab-pane fade" id="menuTab">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card card-custom">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-plus me-2"></i>
                                        <span id="menuFormTitle">เพิ่มเมนูใหม่</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="menuForm">
                                        <input type="hidden" id="editMenuId" value="">
                                        <div class="mb-3">
                                            <label class="form-label">ชื่อเมนู</label>
                                            <input type="text" class="form-control" id="menuName" placeholder="เช่น ราดหน้าหมู" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">ราคา (บาท)</label>
                                            <input type="number" class="form-control" id="menuPrice" placeholder="0" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">หมวดหมู่</label>
                                            <select class="form-select" id="menuCategory">
                                                <option value="ราดหน้า">ราดหน้า</option>
                                                <option value="ก๋วยเตี๋ยว">ก๋วยเตี๋ยว</option>
                                                <option value="เครื่องดื่ม">เครื่องดื่ม</option>
                                                <option value="ของหวาน">ของหวาน</option>
                                                <option value="อื่นๆ">อื่นๆ</option>
                                            </select>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-gradient flex-grow-1">
                                                <i class="fas fa-save me-2"></i>
                                                <span id="menuFormButton">เพิ่มเมนู</span>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="cancelEditBtn" onclick="cancelEdit()" style="display: none;">
                                                <i class="fas fa-times"></i> ยกเลิก
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card card-custom">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>เมนูทั้งหมด</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="allMenus"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // ⚠️ สำคัญ: ใส่ URL ของ Google Apps Script Web App ที่ Deploy แล้วตรงนี้
        const API_URL = 'https://script.google.com/macros/s/AKfycbww6c5yMjCqFKue0KJxoz0VIcBdN7RI0PhlpJtNc8wQ0REfQZZr3fclYqf4anH33gCQ/exec';
        
        // Global variables
        let menuItems = [];
        let currentOrder = [];
        let dailySales = [];
        let dailyExpenses = [];
        let allTransactions = [];
        let isOnline = false;
        let isAPIConfigured = false;

        // Check if API is configured
        function checkAPIConfiguration() {
            isAPIConfigured = API_URL !== 'https://script.google.com/macros/s/AKfycbww6c5yMjCqFKue0KJxoz0VIcBdN7RI0PhlpJtNc8wQ0REfQZZr3fclYqf4anH33gCQ/exec' && API_URL.trim() !== '';
            
            const alertElement = document.getElementById('apiSetupAlert');
            const statusElement = document.getElementById('apiStatus');
            
            if (isAPIConfigured) {
                alertElement.style.display = 'none';
                statusElement.textContent = 'ตั้งค่าแล้ว';
                statusElement.className = 'fw-bold text-success';
            } else {
                alertElement.style.display = 'block';
                statusElement.textContent = 'ยังไม่ได้ตั้งค่า';
                statusElement.className = 'fw-bold text-danger';
            }
            
            return isAPIConfigured;
        }

        // API Functions - ใช้ GET requests เท่านั้นเพื่อหลีกเลี่ยง CORS
        async function callAPI(action, data = {}) {
            if (!isAPIConfigured) {
                console.log('API not configured, working offline');
                return { success: false, offline: true };
            }

            showLoading(true);
            try {
                // แปลง data เป็น URL parameters สำหรับ GET request
                const params = new URLSearchParams({
                    action: action,
                    ...data
                });

                // สำหรับ complex data เช่น items array
                if (data.saleData && data.saleData.items) {
                    params.set('id', data.saleData.id);
                    params.set('total', data.saleData.total);
                    params.set('date', data.saleData.date);
                    params.set('timestamp', data.saleData.timestamp);
                    params.set('items', encodeURIComponent(JSON.stringify(data.saleData.items)));
                    params.delete('saleData');
                }

                if (data.expenseData) {
                    params.set('id', data.expenseData.id);
                    params.set('item', data.expenseData.item);
                    params.set('amount', data.expenseData.amount);
                    params.set('category', data.expenseData.category);
                    params.set('note', data.expenseData.note || '');
                    params.set('date', data.expenseData.date);
                    params.set('timestamp', data.expenseData.timestamp);
                    params.delete('expenseData');
                }

                if (data.menuData) {
                    params.set('id', data.menuData.id);
                    params.set('name', data.menuData.name);
                    params.set('price', data.menuData.price);
                    params.set('category', data.menuData.category);
                    params.delete('menuData');
                }

                const url = `${API_URL}?${params}`;
                console.log('Sending GET request to:', url);

                const response = await fetch(url, {
                    method: 'GET'
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Response data:', result);
                
                updateConnectionStatus(true);
                return result;

            } catch (error) {
                console.error('API Error details:', {
                    message: error.message,
                    stack: error.stack,
                    url: API_URL
                });
                updateConnectionStatus(false);
                return { success: false, error: error.message };
            } finally {
                showLoading(false);
            }
        }

        async function getFromAPI(action, params = {}) {
            if (!isAPIConfigured) {
                console.log('API not configured, working offline');
                return { success: false, offline: true };
            }

            showLoading(true);
            try {
                const queryParams = new URLSearchParams({
                    action: action,
                    ...params
                });

                const url = `${API_URL}?${queryParams}`;
                console.log('Sending GET request to:', url);

                const response = await fetch(url, {
                    method: 'GET'
                });

                console.log('GET Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('GET Response data:', result);
                
                updateConnectionStatus(true);
                return result;
            } catch (error) {
                console.error('GET API Error details:', {
                    message: error.message,
                    stack: error.stack,
                    url: API_URL
                });
                updateConnectionStatus(false);
                return { success: false, error: error.message };
            } finally {
                showLoading(false);
            }
        }                

        // Connection status
        function updateConnectionStatus(online) {
            isOnline = online && isAPIConfigured;
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (isOnline) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'เชื่อมต่อแล้ว';
            } else if (!isAPIConfigured) {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'ออฟไลน์ (ยังไม่ตั้งค่า API)';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'ออฟไลน์';
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // Initialize app
        function startApp() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            initializeApp();
        }

        async function initializeApp() {
            checkAPIConfiguration();
            updateCurrentDate();
            await loadMenuFromAPI();
            await loadTodayDataFromAPI();
            setDefaultMonth();
            updateSummary();
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Bangkok'
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('th-TH', options);
        }

        function setDefaultMonth() {
            const now = new Date();
            const monthString = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthSelector').value = monthString;
        }

        // Menu functions with API
        async function loadMenuFromAPI() {
            const result = await getFromAPI('getMenu');
            if (result.success && result.data) {
                menuItems = result.data;
            } else {
                // Fallback to default menu if API fails
                menuItems = getDefaultMenu();
                if (!result.offline) {
                    showNotification('ไม่สามารถโหลดเมนูจาก API ได้ ใช้เมนูเริ่มต้น', 'warning');
                }
            }
            loadMenuItems();
        }

        function getDefaultMenu() {
            return [
                { id: 1, name: 'ราดหน้าหมู', price: 50, category: 'ราดหน้า' },
                { id: 2, name: 'ราดหน้าทะเล', price: 60, category: 'ราดหน้า' },
                { id: 3, name: 'ราดหน้ารวม', price: 60, category: 'ราดหน้า' },
                { id: 4, name: 'ราดหน้ารวมพิเศษ', price: 80, category: 'ราดหน้า' },
                { id: 5, name: 'ราดหน้าหมูพิเศษ', price: 60, category: 'ราดหน้า' },
                { id: 6, name: 'ราดหน้าทะเลพิเศษ', price: 80, category: 'ราดหน้า' },
                { id: 7, name: 'ก๋วยเตี๋ยวหมู', price: 60, category: 'ก๋วยเตี๋ยว' },
                { id: 8, name: 'เกาเหลาเลือกหมู', price: 60, category: 'ก๋วยเตี๋ยว' },
                { id: 9, name: 'ก๋วยเตี๋ยวหมู พิเศษ', price: 80, category: 'ก๋วยเตี๋ยว' },
                { id: 10, name: 'เกาเหลาเลือกหมู พิเศษ', price: 80, category: 'ก๋วยเตี๋ยว' },
                { id: 11, name: 'น้ำหวาน', price: 20, category: 'เครื่องดื่ม' },
                { id: 12, name: 'น้ำเปล่า 10 บาท', price: 10, category: 'เครื่องดื่ม' },
                { id: 13, name: 'น้ำเปล่ายันฮี', price: 15, category: 'เครื่องดื่ม' },
                { id: 14, name: 'น้ำเปล่าขวดใหญ่', price: 20, category: 'เครื่องดื่ม' },
                { id: 15, name: 'น้ำหวาน 15 บาท', price: 15, category: 'เครื่องดื่ม' },
                { id: 16, name: 'ใส่ไข่', price: 10, category: 'อื่นๆ' },
                { id: 17, name: 'ข้าวเปล่า', price: 10, category: 'อื่นๆ' },
                { id: 18, name: 'ข้าวกระเพราหมูสับ', price: 50, category: 'อื่นๆ' },
                { id: 19, name: 'ข้าวกระเพราทะเล', price: 60, category: 'อื่นๆ' },
                { id: 20, name: 'ข้าวผัดหมูหมัก', price: 50, category: 'อื่นๆ' },
                { id: 21, name: 'ข้าวผัดทะเล', price: 60, category: 'อื่นๆ' },
                { id: 22, name: 'หมูสะเต๊ะ ชุดเล็ก 8 ไม้', price: 60, category: 'ของหวาน' },
                { id: 23, name: 'หมูสะเต๊ะ ชุดใหญ่ 16 ไม้', price: 120, category: 'ของหวาน' }
            ];
        }

        async function loadTodayDataFromAPI() {
            const today = new Date().toISOString().split('T')[0];
            
            // Load sales
            const salesResult = await getFromAPI('getSales', { date: today });
            if (salesResult.success && salesResult.data) {
                dailySales = salesResult.data;
                // Convert to allTransactions format
                salesResult.data.forEach(sale => {
                    const existingIndex = allTransactions.findIndex(t => t.type === 'income' && t.id === sale.id);
                    if (existingIndex === -1) {
                        allTransactions.push({...sale, type: 'income'});
                    }
                });
            }

            // Load expenses
            const expensesResult = await getFromAPI('getExpenses', { date: today });
            if (expensesResult.success && expensesResult.data) {
                dailyExpenses = expensesResult.data;
                // Convert to allTransactions format
                expensesResult.data.forEach(expense => {
                    const existingIndex = allTransactions.findIndex(t => t.type === 'expense' && t.id === expense.id);
                    if (existingIndex === -1) {
                        allTransactions.push({...expense, type: 'expense'});
                    }
                });
            }
        }

        function loadMenuItems() {
            const menuList = document.getElementById('menuList');
            const allMenus = document.getElementById('allMenus');
            menuList.innerHTML = '';
            allMenus.innerHTML = '';
            
            const categories = [...new Set(menuItems.map(item => item.category))];
            categories.forEach(category => {
                const categoryItems = menuItems.filter(item => item.category === category);
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'col-12 mb-3';
                categoryDiv.innerHTML = `
                    <h6 class="text-primary mb-2"><i class="fas fa-utensils me-2"></i>${category}</h6>
                    <div class="row">
                        ${categoryItems.map(item => `
                            <div class="col-md-6 mb-2">
                                <div class="menu-item" onclick="addToOrder(${item.id})">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${item.name}</strong>
                                        </div>
                                        <div class="text-primary fw-bold">
                                            ${item.price} บาท
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                menuList.appendChild(categoryDiv);
                
                categoryItems.forEach(item => {
                    const menuDiv = document.createElement('div');
                    menuDiv.className = 'border rounded p-3 mb-2';
                    menuDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.name}</strong>
                                <small class="text-muted d-block">${item.category}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2">${item.price} บาท</span>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editMenuItem(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    allMenus.appendChild(menuDiv);
                });
            });
        }

        function addToOrder(menuId) {
            const menuItem = menuItems.find(item => item.id === menuId);
            if (menuItem) {
                const existingItem = currentOrder.find(item => item.id === menuId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    currentOrder.push({
                        ...menuItem,
                        quantity: 1
                    });
                }
                updateOrderDisplay();
            }
        }

        function updateOrderDisplay() {
            const orderList = document.getElementById('orderList');
            const totalAmount = document.getElementById('totalAmount');
            
            if (currentOrder.length === 0) {
                orderList.innerHTML = '<div class="text-center text-muted">ยังไม่มีรายการสั่งซื้อ</div>';
                totalAmount.textContent = '0 บาท';
                return;
            }

            let total = 0;
            orderList.innerHTML = currentOrder.map(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                return `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.name}</strong>
                                <div class="small text-muted">${item.price} บาท x ${item.quantity}</div>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="decreaseQuantity(${item.id})">-</button>
                                <span class="mx-2">${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="increaseQuantity(${item.id})">+</button>
                                <strong class="text-success">${subtotal} บาท</strong>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            totalAmount.textContent = total.toLocaleString() + ' บาท';
        }

        function increaseQuantity(menuId) {
            const item = currentOrder.find(item => item.id === menuId);
            if (item) {
                item.quantity += 1;
                updateOrderDisplay();
            }
        }

        function decreaseQuantity(menuId) {
            const item = currentOrder.find(item => item.id === menuId);
            if (item) {
                item.quantity -= 1;
                if (item.quantity <= 0) {
                    currentOrder = currentOrder.filter(orderItem => orderItem.id !== menuId);
                }
                updateOrderDisplay();
            }
        }

        function clearOrder() {
            currentOrder = [];
            updateOrderDisplay();
        }

        async function processOrder() {
            if (currentOrder.length === 0) {
                showNotification('กรุณาเลือกเมนูก่อนชำระเงิน', 'warning');
                return;
            }

            const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderData = {
                id: Date.now(),
                items: [...currentOrder],
                total: total,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0]
            };

            // Save to API
            if (isOnline) {
                const result = await callAPI('addSale', { saleData: orderData });
                if (result.success) {
                    showNotification('บันทึกการขายสำเร็จ!', 'success');
                } else {
                    showNotification('ไม่สามารถบันทึกลง Server ได้ แต่บันทึกในเครื่องแล้ว', 'warning');
                }
            }

            // Save locally as backup
            dailySales.push(orderData);
            allTransactions.push({...orderData, type: 'income'});

            showNotification(`ชำระเงินสำเร็จ!\nยอดรวม: ${total.toLocaleString()} บาท`, 'success');
            clearOrder();
            updateSummary();
        }

        // Expense Management with API
        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const expenseData = {
                id: Date.now(),
                item: document.getElementById('expenseItem').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                category: document.getElementById('expenseCategory').value,
                note: document.getElementById('expenseNote').value,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0]
            };

            // Save to API
            if (isOnline) {
                const result = await callAPI('addExpense', { expenseData });
                if (result.success) {
                    showNotification('บันทึกรายจ่ายสำเร็จ!', 'success');
                } else {
                    showNotification('ไม่สามารถบันทึกลง Server ได้ แต่บันทึกในเครื่องแล้ว', 'warning');
                }
            }

            // Save locally as backup
            dailyExpenses.push(expenseData);
            allTransactions.push({...expenseData, type: 'expense'});

            document.getElementById('expenseForm').reset();
            updateTodayExpenses();
            updateSummary();
            
            if (!isOnline) {
                showNotification('บันทึกรายจ่ายสำเร็จ! (ออฟไลน์)', 'info');
            }
        });

        // Menu Management with API
        document.getElementById('menuForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editMenuId').value;
            const menuData = {
                name: document.getElementById('menuName').value,
                price: parseFloat(document.getElementById('menuPrice').value),
                category: document.getElementById('menuCategory').value
            };

            if (editId) {
                // Edit existing menu
                menuData.id = parseInt(editId);
                
                if (isOnline) {
                    const result = await callAPI('updateMenu', { menuData });
                    if (!result.success) {
                        showNotification('ไม่สามารถอัพเดตลง Server ได้ แต่อัพเดตในเครื่องแล้ว', 'warning');
                    }
                }
                
                const menuIndex = menuItems.findIndex(item => item.id == editId);
                if (menuIndex !== -1) {
                    menuItems[menuIndex] = { ...menuItems[menuIndex], ...menuData };
                    showNotification('แก้ไขเมนูสำเร็จ!', 'success');
                }
                cancelEdit();
            } else {
                // Add new menu
                const newMenu = {
                    id: Date.now(),
                    ...menuData
                };
                
                if (isOnline) {
                    const result = await callAPI('addMenu', { menuData: newMenu });
                    if (!result.success) {
                        showNotification('ไม่สามารถบันทึกลง Server ได้ แต่บันทึกในเครื่องแล้ว', 'warning');
                    }
                }
                
                menuItems.push(newMenu);
                showNotification('เพิ่มเมนูสำเร็จ!', 'success');
            }

            document.getElementById('menuForm').reset();
            loadMenuItems();
        });

        function editMenuItem(menuId) {
            const menuItem = menuItems.find(item => item.id === menuId);
            if (!menuItem) return;

            document.getElementById('editMenuId').value = menuItem.id;
            document.getElementById('menuName').value = menuItem.name;
            document.getElementById('menuPrice').value = menuItem.price;
            document.getElementById('menuCategory').value = menuItem.category;

            document.getElementById('menuFormTitle').innerHTML = '<i class="fas fa-edit me-2"></i>แก้ไขเมนู';
            document.getElementById('menuFormButton').textContent = 'บันทึกการแก้ไข';
            document.getElementById('cancelEditBtn').style.display = 'block';

            const cardHeader = document.querySelector('#menuTab .card-header');
            cardHeader.className = 'card-header bg-warning text-dark';

            document.getElementById('menuForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('menuForm').reset();
            document.getElementById('editMenuId').value = '';
            document.getElementById('menuFormTitle').innerHTML = '<i class="fas fa-plus me-2"></i>เพิ่มเมนูใหม่';
            document.getElementById('menuFormButton').textContent = 'เพิ่มเมนู';
            document.getElementById('cancelEditBtn').style.display = 'none';

            const cardHeader = document.querySelector('#menuTab .card-header');
            cardHeader.className = 'card-header bg-success text-white';
        }

        function updateTodayExpenses() {
            const container = document.getElementById('todayExpenses');
            const today = new Date().toISOString().split('T')[0];
            const todayExp = dailyExpenses.filter(exp => exp.date === today);
            
            if (todayExp.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">ยังไม่มีรายจ่ายวันนี้</div>';
                return;
            }

            container.innerHTML = todayExp.map(expense => `
                <div class="expense-item d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${expense.item}</strong>
                        <div class="small text-muted">${expense.category}</div>
                        ${expense.note ? `<div class="small">${expense.note}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <strong class="text-danger">${expense.amount.toLocaleString()} บาท</strong>
                        <div class="small text-muted">${new Date(expense.timestamp).toLocaleTimeString('th-TH')}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateSummary() {
            const today = new Date().toISOString().split('T')[0];
            
            const todayIncome = dailySales
                .filter(sale => sale.date === today)
                .reduce((sum, sale) => sum + sale.total, 0);
            
            const todayExpense = dailyExpenses
                .filter(exp => exp.date === today)
                .reduce((sum, exp) => sum + exp.amount, 0);
            
            const todayProfit = todayIncome - todayExpense;

            document.getElementById('todayIncome').textContent = todayIncome.toLocaleString() + ' บาท';
            document.getElementById('todayExpense').textContent = todayExpense.toLocaleString() + ' บาท';
            document.getElementById('todayProfit').textContent = todayProfit.toLocaleString() + ' บาท';

            updateTodayExpenses();
        }

        async function updateMonthlySummary() {
            const selectedMonth = document.getElementById('monthSelector').value;
            if (!selectedMonth) return;

            const [year, month] = selectedMonth.split('-');
            
            // Try to get from API first
            if (isOnline) {
                const result = await getFromAPI('getMonthlySummary', { year, month });
                if (result.success && result.data) {
                    displayMonthlySummary(result.data, selectedMonth);
                    return;
                }
            }

            // Fallback to local calculation
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            const monthlyTransactions = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate >= startDate && transactionDate <= endDate;
            });

            const monthlyIncome = monthlyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.total, 0);
            
            const monthlyExpense = monthlyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyProfit = monthlyIncome - monthlyExpense;

            const summaryData = {
                totalIncome: monthlyIncome,
                totalExpense: monthlyExpense,
                profit: monthlyProfit,
                transactions: monthlyTransactions
            };

            displayMonthlySummary(summaryData, selectedMonth);
        }

        function displayMonthlySummary(data, monthYear) {
            const summaryContainer = document.getElementById('monthlySummary');
            const transactions = data.transactions || [];

            summaryContainer.innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="p-3 bg-success text-white rounded">
                            <h6>รายรับ</h6>
                            <h5>${data.totalIncome.toLocaleString()} บาท</h5>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 bg-danger text-white rounded">
                            <h6>รายจ่าย</h6>
                            <h5>${data.totalExpense.toLocaleString()} บาท</h5>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 ${data.profit >= 0 ? 'bg-primary' : 'bg-warning'} text-white rounded">
                            <h6>กำไร/ขาดทุน</h6>
                            <h5>${data.profit.toLocaleString()} บาท</h5>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>รายละเอียดรายการ</h6>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${
                            transactions.length === 0
                            ? '<div class="text-center text-muted">ไม่มีรายการในเดือนนี้</div>'
                            : transactions.map(transaction => `
                                <div class="border-bottom py-2 d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${transaction.type === 'income' ? 'ขาย' : transaction.item}</strong>
                                        <small class="text-muted d-block">
                                            ${new Date(transaction.timestamp).toLocaleDateString('th-TH')}
                                        </small>
                                    </div>
                                    <span class="${transaction.type === 'income' ? 'text-success' : 'text-danger'}">
                                        ${transaction.type === 'income' ? '+' : '-'}${(transaction.total || transaction.amount).toLocaleString()} บาท
                                    </span>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        }

        function exportToExcel() {
            const selectedMonth = document.getElementById('monthSelector').value;
            if (!selectedMonth) {
                showNotification('กรุณาเลือกเดือนที่ต้องการส่งออก', 'warning');
                return;
            }

            const [year, month] = selectedMonth.split('-');
            const monthName = new Date(year, month - 1).toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
            
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            const monthlyTransactions = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate >= startDate && transactionDate <= endDate;
            });

            const monthlyIncome = monthlyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.total, 0);
            
            const monthlyExpense = monthlyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const exportData = `รายงานประจำเดือน ${monthName}
ร้านราดหน้ามหาชน
================================

สรุป:
รายรับ: ${monthlyIncome.toLocaleString()} บาท
รายจ่าย: ${monthlyExpense.toLocaleString()} บาท
กำไร: ${(monthlyIncome - monthlyExpense).toLocaleString()} บาท

รายละเอียดรายรับ:
${monthlyTransactions.filter(t => t.type === 'income').map(sale => 
    `${new Date(sale.timestamp).toLocaleDateString('th-TH')} - ${sale.total.toLocaleString()} บาท`
).join('\n')}

รายละเอียดรายจ่าย:
${monthlyTransactions.filter(t => t.type === 'expense').map(expense => 
    `${new Date(expense.timestamp).toLocaleDateString('th-TH')} - ${expense.item} - ${expense.amount.toLocaleString()} บาท`
).join('\n')}
            `;

            downloadTextFile(exportData, `รายงานร้านราดหน้ามหาชน-${selectedMonth}.txt`);
        }

        function exportDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayDate = new Date().toLocaleDateString('th-TH');
            
            const todayIncome = dailySales
                .filter(sale => sale.date === today)
                .reduce((sum, sale) => sum + sale.total, 0);
            
            const todayExpense = dailyExpenses
                .filter(exp => exp.date === today)
                .reduce((sum, exp) => sum + exp.amount, 0);

            const reportData = `รายงานประจำวัน ${todayDate}
ร้านราดหน้ามหาชน
================================

สรุป:
รายรับ: ${todayIncome.toLocaleString()} บาท
รายจ่าย: ${todayExpense.toLocaleString()} บาท
กำไร: ${(todayIncome - todayExpense).toLocaleString()} บาท

รายละเอียดการขาย:
${dailySales.filter(sale => sale.date === today).map(sale => 
    `${new Date(sale.timestamp).toLocaleTimeString('th-TH')} - ${sale.total.toLocaleString()} บาท`
).join('\n')}

รายละเอียดรายจ่าย:
${dailyExpenses.filter(exp => exp.date === today).map(expense => 
    `${new Date(expense.timestamp).toLocaleTimeString('th-TH')} - ${expense.item} - ${expense.amount.toLocaleString()} บาท`
).join('\n')}
            `;

            downloadTextFile(reportData, `รายงานวันนี้-${today}.txt`);
        }

        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    if (e.target.getAttribute('href') === '#summaryTab') {
                        updateMonthlySummary();
                    }
                });
            });

            // Test API connection on load
            setTimeout(async () => {
                if (isAPIConfigured) {
                    try {
                        const testResult = await getFromAPI('getMenu');
                        updateConnectionStatus(testResult.success);
                    } catch (error) {
                        updateConnectionStatus(false);
                    }
                } else {
                    updateConnectionStatus(false);
                }
            }, 1000);
        });

        // Sync data periodically if online
        setInterval(async () => {
            if (isOnline) {
                await loadTodayDataFromAPI();
                updateSummary();
            }
        }, 60000); // Sync every minute
    </script>
</body>
</html>
